<!DOCTYPE HTML>
<html lang="en-US" class="fade">
<head>
  <meta charset="UTF-8">
  <title>Nixpkgs Overlays</title>

<!--

Goal:
 - Push for larger adoption of overlays.
 - Replace old method for doing the same thing.
 - Provide a reference for making good overlays. (and explain why)

Plan:
 - What are overlays made for:
   - Extend Nixpkgs without modifying Nixpkgs.
   - Externally modify Nixpkgs.
   - Keep the same syntax as Nixpkgs as much as possible.
   - Share your work without conflict.

 - Good examples of overlays:
   - empty overlay.
   - change the configuration.
   - change the source.
   - nixpkgs-mozilla
     - Firefox.
       - internals of the firefox overlay (optional)
     - Rust
       - internals of the rust overlay (optional)
   - nixpkgs-dapphub

 - Implementation of overlays:
   - Understanding Nixpkgs.
   - Understanding layers.
   - 

 - Bad examples of overlays:
   - packageOverrides = super: ...
   - import <nixpkgs>
   - self vs. super
   - rec {}

Talk:

* off-topic intro: Last time in Munchen, Part Time Scientist & DLR.
  -> Being remote did not help at following what others did.
  -> Similar to packages outside Nixpkgs.
     - Have a different interface. (look and feel different)

* goal of overlays:
 - Remove as much of possible what makes an overlay different from Nixpkgs.
 - Make external extensiblibility the default.
 - Make extensibility modular.
 - Make it possible to share code, the way code is sahred, not in forums!



sed -n 's/&amp;/&/g; s/&gt;/>/g; s/&lt;/</g; /^\$/ p;' index.html

-->

  <meta name="viewport" content="width=device-width, user-scalable=yes">
  <link rel="stylesheet" href="styles/style.css">
</head>
<body class="list">
  <header class="caption">
    <h1>Nixpkgs Overlays</h1>
    <p class="footer">
      Nicolas B. Pierron
    </p>
  </header>
  <aside class="talkdescription">
    <p>This slide deck is using the shower system - roll over the previews to see the notes and click any slide to go into presentation mode. Then use keys to navigate. <button onclick="goFullScreen()">Go fullscreen</button></p>
    <p class="abstract">
      <strong>Abstract: </strong>

      This presentation introduce Nixpkgs overlays, and show the do and don't of it. It then
      describe how it is implemented, and examples of almost a year of overlays gave us.

    </p>
  </aside>


  <div id="cover" class="slide cover h"><div>
    <section>
      <header>
        <h2 style="text-align: center;">Nixpkgs Overlays</h2>
      </header>
      <img src="img/1993_sts61_liftoff.jpg"
           class="middle shadow" width="100%" height="100%"
           alt="">
      <small class="byline">
        Nicolas B. Pierron<br>
        NixCon 2017
      </small>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="presentation" class="slide"><div>
    <section>
      <header>
        <h2>This Presenetation</h2>
      </header>
      <ul>
        <li>Why adding overlays?</li>
        <li>How to use them?</li>
        <li>How do they work?</li>
        <li>What we do with them?</li>
      </ul>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="trust-who" class="slide"><div>
    <section>
      <header>
        <h2>Trust, Who?</h2>
      </header>
      <p>Can we even trust software makers?</p>
      <ol>
        <li>Do they care <strong>about you</strong>?</li>
        <li>Are issues <strong>fixed</strong> quickly?</li>
        <li>Are fixes <strong>released</strong> quickly?</li>
      </ol>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="trust-example" class="slide"><div>
    <section>
      <header>
        <h2>Examples</h2>
      </header>
      <ol>
        <li>Android?</li>
        <li>Firefox?</li>
        <li>NixOS?</li>
      </ol>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="android-example" class="slide"><div>
    <section>
      <header>
        <h2>Android Example</h2>
      </header>
      <img class="middle" width="90%" src="img/Android_historical_version_distribution_-_vector.svg">
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="firefox-example" class="slide"><div>
    <section>
      <header>
        <h2>Firefox Example</h2>
      </header>
      <img class="middle" width="95%" src="img/firefox-releases.png">
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="making-updates" class="slide"><div>
    <section>
      <header>
        <h2>Making Security Updates</h2>
      </header>
      <p>Exceptional implies stress, stress implies mistakes:</p>
      <ul>
        <li>Typos.</li>
        <li>Copy & Pasta.</li>
      </ul>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="firefox-chemspill" class="slide"><div>
    <section>
      <header>
        <h2>Chemspill</h2>
      </header>
      <img class="right" src="img/mozilla_chem_spill.png">
      <p>Make a process</p>
      <ul>
        <li>Reduce mistakes.</li>
        <li>Improve the speed.</li>
      </ul>
      <footer class="notes">
      </footer>
    </section>
  </div></div>

  <div id="firefox-chemspill-timeline" class="slide"><div>
    <section>
      <header>
        <h2>Chemspill Timeline</h2>
      </header>
      <img class="middle" width="95%" src="img/chemspill-timeline.png">
      <footer class="notes">
        <p>This graph highlights how builds are going and how they are
          released to Firefox users. So, as Mozilla is able to provide
          frequent fixes, they are also capable of releasing these within a
          few hours to Linux users, and within a day to windows users.</p>
        <p>So, let's look how we propose to release updates of sofware such
          as Firefox</p>
        <pre>
          http://www.aosabook.org/en/ffreleng.html
          This work is made available under the Creative Commons Attribution
          3.0 Unported license.
        </pre>
      </footer>
    </section>
  </div></div>

  <div id="how-do-we-ship-today" class="slide"><div>
    <section>
      <header>
        <h2>NixOS Example</h2>
      </header>
      <p>Suggested ways:</p>
      <ul>
        <!-- <li>Rebuild critical path.</li> -->
        <li>Default channel: Long critical path. (when it builds)</li>
        <li>Small channel: small ciritcal path (with local rebuilds).</li>
        <li>Do it yourself <code>pkgs.replaceDependency</code> or
        <code>system.replaceRuntimeDependencies</code>.</li>
      </ul>
      <footer class="notes">
        <p>So far, we have multiple ways to handle such releases.</p>
        <pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="nixos-example" class="slide"><div>
    <section>
      <header>
        <h2>NixOS Example</h2>
      </header>
      <p>Dear user, please proceed as follow:</p>
      <pre style="font-size:0.7em;left:45px;position:absolute;"><code>system.replaceRuntimeDependencies = with pkgs; [
  ({ original = openssl;
     replacement = callPackage /some/path/nixpkgs/pkgs/development/libraries/openssl {
       fetchurl = fetchurlBoot;
       cryptodevHeaders = linuxPackages.cryptodev.override {
         fetchurl = fetchurlBoot;
         onlyHeaders = true;
       };
     };
  })
];</code></pre>
      <footer class="notes">
        <p>.</p>
        <pre>
        https://nixos.org/wiki/Security_Updates
      </pre></footer>
    </section>
  </div></div>

  <div id="nixos-requirements" class="slide"><div>
    <section>
      <header>
        <h2>NixOS Requirements</h2>
      </header>
      <p>Require:</p>
      <ul>
        <li>User awareness.</li>
        <li>User actions.</li>
        <li>ABI compatible versions.</li>
        <li>Security updates are the exception. (not the rule)</li>
      </ul>
      <p>Otherwise: Normal updates are shipped in a month.</p>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="nixos-trust" class="slide"><div>
    <section>
      <header>
        <h2>Trust NixOS?</h2>
      </header>
      <img class="right" width="50%" src="img/Heartbleed.svg">
      <p style="text-align: center; margin-top: 7em;">Yes-ish<br>which means<br>No</p>
      <footer class="notes"><pre>
        http://heartbleed.com/
        Heartbleed logo is free to use, rights waived via <a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.
      </pre></footer>
    </section>
  </div></div>

  <div id="world-of-tomorrow" class="slide"><div>
    <section>
      <header>
        <h2>Security Issues</h2>
      </header>
      <img src="img/futurama_world_of_tomorrow.jpg" style="margin-bottom:3em;">
      <img src="img/suicide-booth.jpg">
      <footer class="notes"><pre>
        Futurama
      </pre></footer>
    </section>
  </div></div>

  <!--
  <div id="but-how-others-do" class="slide"><div>
    <section>
      <header>
        <h2>Other Distributions</h2>
      </header>
      <p>How do others do:</p>
      <ul>
        <li>Rely on shared libraries.</li>
        <li>Update <strong>only faulty</strong> packages.</li>
        <li>Do not necessary restart jobs.</li>
      </ul>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="how-do-we-ship-today" class="slide"><div>
    <section>
      <header>
        <h2>Shipping Nixpkgs</h2>
      </header>
      <p>Suggested ways:</p>
      <ul>
        <li>Rebuild critical path.</li>
        <li>Default channel: Long critical path. (when it builds)</li>
        <li>Small channel: small ciritcal path (with local rebuilds).</li>
        <li>Get your hands dirty with <code>pkgs.replaceDependency</code>.</li>
      </ul>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>
  -->

  <div id="grmbl-replaceDependency" class="slide"><div>
    <section>
      <header>
        <h2>pkgs.replaceDependency</h2>
      </header>
      <p>Substitute references inside package outputs:</p>
      <ul>
        <li>Maintained by hand.</li>
        <li>Realize packages during the evaluation.</li>
        <li>Realize the packages to apply the fixes.</li>
        <li>Lack support for statically linked packages.</li>
        <!--
        <li>Do not distinguish sources of hashes.</li>
        -->
      </ul>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="one-problem-at-a-time" class="slide"><div>
    <section>
      <header>
        <h2>One problem at a time</h2>
      </header>
      <p>By order of importance:</p>
      <ol>
        <li>Make it <strong>transparent</strong> for users.</li>
        <li>Make it <strong>fast</strong> for Hydra.</li>
        <li>Make it <strong>easy</strong> for package managers.</li>
        <li>Make it <strong>sane</strong>. (no build during evaluation)</li>
      </ol>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="transpartent-0" class="slide"><div>
    <section>
      <header>
        <h2>Transparent</h2>
      </header>
      <pre><code>$ nix-channel --update
$ nix-env -u firefox
      </code></pre>
      <p>Should become:</p>
      <pre><code>$ nix-channel --update
$ nix-env -u firefox</code></pre>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="transpartent-1" class="slide"><div>
    <section>
      <header>
        <h2>Transparent (Ideal)</h2>
      </header>
      <pre><code>$ nix-channel --update
$ nix-env -u firefox
      </code></pre>
      <p>Should become:</p>
      <pre><code>
      </code></pre>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-0" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <ul>
        <li>Fixed packages should have the same layout as Nixpkgs.</li>
      </ul>
      <img class="middle" width="90%" style="padding-top:350px;" src="img/nixpkgs-loop.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="fast-0" class="slide"><div>
    <section>
      <header>
        <h2>Fast</h2>
      </header>
      <p>Break the critical path in parallel compilation.</p>
      <p>Do not recompile when a dependency change.</p>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="fast-1" class="slide"><div>
    <section>
      <header>
        <h2>Fast &amp; Sane</h2>
      </header>
      <img class="middle" width="90%" src="img/abifixpkgs-2.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-loop-repeat" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Generate the same set of packages.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-repeat.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-loop-plus-one" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Generate the same set of packages with one extra no-op iteration.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-plus-one.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-loop-quickfix" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Recompile fixed packages based on fixpoint of stable packages.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-quickfix.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-loop-quickfix-twice" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Partially recompile fixed packages based on fixed packages.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-quickfix-twice.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="implies-loop-quickfix-recompile" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Entirelly recompile fixed packages based on fixed packages.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-quickfix-recompile.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <!--
  <div id="implies-loop-quickfix-patch" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Use the recompiled-info as a hint for patching with dependencies.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-quickfix-patch.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>
  -->

  <div id="implies-loop-quickfix-whatif-patch" class="slide"><div>
    <section>
      <header>
        <h2>Implicitcations</h2>
      </header>
      <p>Use the recompiled-info as a hint for patching with dependencies.</p>
      <img class="middle" width="90%" src="img/nixpkgs-loop-quickfix-whatif-patch.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="easy-0" class="slide"><div>
    <section>
      <header>
        <h2>Easy</h2>
      </header>
      <p>3 lists of packages:</p>
      <ul>
        <li>Latest compiled branch.</li>
        <li>ABI compatible changes branch.</li>
        <li>Security channel. (merges both)</li>
      </ul>
      <img class="middle" width="90%" style="padding-left:900px;" src="img/nixpkgs-loop-quickfix.svg">
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="release-management" class="slide"><div>
    <section>
      <header>
        <h2>Release Management</h2>
      </header>
      <p>Packagers options:</p>
      <ul>
        <li>Push to master &amp; Cherry-pick ABI compatible changes.</li>
        <li>Push to ABI changes &amp; Cherry-pick in master.</li>
      </ul>
      <p>On new stable channel update:</p>
      <ul>
        <li>Merge master into the ABI branch.</li>
        <li>Reset the ABI branch.</li>
      </ul>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

<!-- sane? -->

  <div id="remaining-issues" class="slide"><div>
    <section>
      <header>
        <h2>Remaining Issues</h2>
      </header>
      <p>What is left for improvements:</p>
      <ul>
        <li>Use runtime dependencies generated by Hydra.</li>
        <li>Automated updates for registered packages.</li>
        <li>Support for statically linked packages.</li>
        <!--
        <li>Distinguish sources of hashes.</li>
        -->
      </ul>
      <footer class="notes"><pre>
      </pre></footer>
    </section>
  </div></div>

  <div id="the-end" class="slide cover h"><div>
    <section>
      <header>
        <h2 style="text-align: center;">Questions?</h2>
      </header>
      <img src="img/STS-31_Hubble_launch_roll_and_pitch.jpg"
           class="middle shadow" height="100%"
           alt="">
      <footer class="notes"><pre>
          NASA - STS-31 - Hubble launch.
      </pre></footer>
    </section>
  </div></div>

  <!--
    To hide progress bar from entire presentation
    just remove “progress” element.
    -->
  <div class="progress"><div></div></div>
  <script src="scripts/script.js"></script>
  <!-- Copyright © 2010–2012 Vadim Makeev — pepelsbey.net -->
  <!-- Copyright © 2010–2012 Vadim Makeev — pepelsbey.net -->
</body>
</html>

